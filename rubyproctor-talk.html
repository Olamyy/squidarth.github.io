<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif);
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: 'Droid Serif';
      }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content h1 { font-size: 3em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      li p { line-height: 1.25em; }
      .red { color: #fa0000; }
      .large { font-size: 2em; }
      a, a > code {
        color: rgb(249, 38, 114);
        text-decoration: none;
      }
      code {
        background: #e7e8e2;
        border-radius: 5px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      .pull-left {
        float: left;
        width: 47%;
      }
      .pull-right {
        float: right;
        width: 47%;
      }
      .pull-right ~ p {
        clear: both;
      }
      #slideshow .slide .content code {
        font-size: 0.8em;
      }
      #slideshow .slide .content pre code {
        font-size: 0.9em;
        padding: 15px;
      }
      .inverse {
        background: #272822;
        color: #777872;
        text-shadow: 0 0 20px #333;
      }
      .inverse h1, .inverse h2 {
        color: #f3f3f3;
        line-height: 0.8em;
      }

      /* Slide-specific styling */
      #slide-inverse .footnote {
        bottom: 12px;
        left: 20px;
      }
      #slide-how .slides {
        font-size: 0.9em;
        position: absolute;
        top:  151px;
        right: 140px;
      }
      #slide-how .slides h3 {
        margin-top: 0.2em;
      }
      #slide-how .slides .first, #slide-how .slides .second {
        padding: 1px 20px;
        height: 90px;
        width: 120px;
        -moz-box-shadow: 0 0 10px #777;
        -webkit-box-shadow: 0 0 10px #777;
        box-shadow: 0 0 10px #777;
      }
      #slide-how .slides .first {
        background: #fff;
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 1;
      }
      #slide-how .slides .second {
        position: relative;
        background: #fff;
        z-index: 0;
      }
      /* Two-column layout even */
      .left-column-even {
        color: #777;
        width: 50%;
        height: 92%;
        float: left;
      }
      .right-column-even {
        width: 50%;
        float: right;
        padding-top: 1em;
      }

      /* Two-column layout */
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
        .left-column h2:last-of-type, .left-column h3:last-child {
          color: #000;
        }
      .right-column {
        width: 75%;
        float: right;
        padding-top: 1em;
      }
    </style>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse
---
# Safely Running User-Provided Code

Sid Shanker - Fog City Ruby 01-09-2018
---
layout: false
## What I'll be covering

1. Motivations: Rubocop and Rubyproctor
2. Running user-provided code safely
---
layout: false

## Rubocop
  .left-column-even[
    RuboCop is a command line tool that allows you to enforce coding styles
    on your codebase. Using Rubocop:
* Saves time in code review (no need to deal with nits)
* Educates developers
* Reduces # of bike-shedding arguments
  ]
  .right-column-even[

![Right-aligned image](rubocop_logo.png)
  ]
  .footnote[Image from: http://rubocop.readthedocs.io/en/latest/]
---
layout: false
  ## Rubocop
Rubocop comes with configurable set of rules that you can toggle on/off

Example snippet of Rubocop configuration:

```yaml
Metrics/LineLength:
  Max: 120

Style/CollectionMethods:
  Enabled: true
  PreferredMethods:
    reduce: "inject"

Style/AlignHash:
  EnforcedHashRocketStyle: table
  EnforcedColonStyle: table
    ```

Rubocop also allows you to write your own rules. However, writing these custom rules
can be somewhat annoying to do.
---

## Enter: RubyProctor

.left-column-even[
  ### What is it?

  RubyProctor is a simple website for rapidly developing RuboCop rules.

  It provides the Ruby AST of some example code, and as you type, evaluates the rule you have provided.

  [Demo](https://rubyproctor.com)
]
.right-column-even[
  ![Right-aligned image](rubyproctor_ss.png)
]
---
class: center, middle
![Right-aligned image](danger_gif.gif)
---
## What could *possibly* go wrong?

Someone could:

* Turn rubyproctor into a miner for the latest hip alt-coin
* Start a DDoS attack against another website
* Fork a bunch of processes and crash the server
.left-column-even[
  ![Right-aligned image](rfrfstar.png)
]
---
class: center, middle
## Protect the filesystem
---
.left-column[
  ## Protecting the filesystem
### - Use Docker
]
.right-column[
# Use Docker

Docker is a system that allows developers to run applications in "containers", that are
much more lightweight than VMs, but are still isolated from the the machine they are running on.

They are also isolated from each other, so if an attacker *did* manage to modify files in the container,
you can always just destroy it and start a new one.

![Right-aligned image](docker_logo.png)
]
---
.left-column[
  ## Protecting the filesystem
### - Use Docker
### - Set the filesystem to read-only
]
.right-column[
# Use the --read-only flag when running the container

`docker run` has a `--read-only` option (see [the docs](https://docs.docker.com/engine/reference/commandline/run/#options))
that mounts the root filesystem as read-only.

This prevents any attacker from modifying any files on the file system at all, preventing attacks involving corrupting data
]
---
class: center, middle
## Network Access
---

.left-column[
 ## Network Access
 ### - Disabling External Network Access
]

.right-column[

# Disabling Network Access

Allowing clients to make arbitrary network calls is dangerous because
of the potential to use your server to launch another attack on a site.

Disabling docker network access is a different process--I will be demonstrating
it on a simple docker daemon. There are different solutions for clustered docker setups
like Kubernetes or Elastic Container Service.

![Right-aligned image](unplugged_ethernet.jpg)
]

.right-column[.footnote[[Photo Credit](https://c1.staticflickr.com/7/6196/6088751332_7da4134066_b.jpg)]]
---
class: center, middle
## Process Permissions
---
.left-column[
 ## Process Permissions
 ### - rlimits
]

.right-column[
 # rlimits

 Linux has a handy way of setting kernel-enforced resource limits
 on individual processes.

 See the full list [here](https://www.systutorials.com/docs/linux/man/2-setrlimit/#lbAE).

 The two relevant ones to this project are `RLIMIT_NPROC` and `RLIMIT_CPU`.

 These regulate
 the number of processes that a process is allowed to create and the amount of CPU time a
 process is allowed to use respectively.

]
---
.left-column[
## Process Permissions
### - rlimits
### - Setting rlimits in Ruby
]

.right-column[
# Setting rlimits in Ruby

Setting `rlimits` on proceses in Ruby is simply a matter of
passing arguments to `Process.spawn`.

```ruby
Process.spawn(
  "ruby runner.rb #{arg}",
  rlimit_nproc: [2,2],
  rlimit_cpu: [2,2]
)
```

Other libraries for running shell commands, such as `Open3`, typically wrap `Process.spawn`
and also support these arguments.
]
---
.left-column[
## Process Permissions
### - rlimits
### - Setting rlimits in Ruby
### - How ironclad are these limits?
]

.right-column[
# How ironclad are these limits?

`rlimits` are enforced by the Linux kernel, and
once set on a process by a parent process, cannot be changed.

To demonstrate:

```ruby
# parent_script.rb
Process.spawn(
  "ruby child_script.rb",
  rlimit_nproc: [2,2],
)
```

```ruby
# child_script.rb
Process.setrlimit(Process::RLIMIT_NPROC, 5)

# raises Operation not permitted - setrlimit (Errno::EPERM)
```
]
---
# Further Reading

* [RubyProctor](https://rubyproctor.com)
* [Rubocop Documentation](http://rubocop.readthedocs.io/en/latest/)
* [Docker Storage, Image, and Containers](https://docs.docker.com/engine/userguide/storagedriver/imagesandcontainers/#sharing-promotes-smaller-images)
* [Docker Container Networking ](https://docs.docker.com/engine/userguide/networking/#default-networks)
* [Does GNU/Linux counts processes and threads together when I limit their number?  ](https://superuser.com/questions/376532/does-gnu-linux-counts-processes-and-threads-together-when-i-limit-their-number )
* [limits.conf documentation](https://linux.die.net/man/5/limits.conf)
* [More details on rlimits](https://www.systutorials.com/docs/linux/man/2-setrlimit/#lbAE)
---
# Questions?

Again, I'm Sid Shanker.

**Email:** sid.p.shanker@gmail.com

**Twitter:** [@sidpshanker](https://twitter.com/sidpshanker)

**Github:** [@squidarth](https://github.com/squidarth)
    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
